<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - AutoExpert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen font-sans">

    <nav class="bg-white dark:bg-gray-800 shadow mb-8">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <span class="font-bold text-xl text-blue-600">AutoExpert <span class="text-gray-600 dark:text-gray-300 text-sm">| Statistiques</span></span>
            <div class="flex items-center space-x-4">
                <div id="sms-balance-container" class="hidden px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium dark:bg-blue-900 dark:text-blue-200 flex items-center" title="Crédit SMS restant">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="sms-balance">--</span>
                </div>
                <a href="admin.html" class="text-sm text-gray-500 hover:text-blue-600">Planning</a>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">Déconnexion</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 pb-12">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Statistiques des Rendez-vous</h3>
                <div class="relative h-80 w-full">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Revenus par Marque</h3>
                <div class="relative h-80 w-full">
                    <canvas id="brandRevenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Revenus Mensuels (€)</h3>
                        <div class="flex flex-col sm:flex-row sm:gap-6 mt-1">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total : <span id="total-revenue" class="font-bold text-2xl text-blue-600 dark:text-blue-400">0.00 €</span></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center">Panier moyen : <span id="average-revenue" class="font-bold text-xl text-green-600 dark:text-green-400 ml-2">0.00 €</span></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <select id="quarter-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="all">Toute l'année</option>
                            <option value="1">Q1 (Jan-Mar)</option>
                            <option value="2">Q2 (Avr-Juin)</option>
                            <option value="3">Q3 (Juil-Sept)</option>
                            <option value="4">Q4 (Oct-Déc)</option>
                        </select>
                        <select id="year-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                    </div>
                </div>
                <div class="relative h-80 w-full">
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="mt-8 overflow-hidden border border-gray-200 dark:border-gray-700 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Mois</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Revenu</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Évolution des Prises de Rendez-vous</h3>
            <div class="relative h-80 w-full">
                <canvas id="appointmentsEvolutionChart"></canvas>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Taux de Conversion Mensuel (%)</h3>
            <div class="relative h-80 w-full">
                <canvas id="conversionRateChart"></canvas>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Délai Moyen d'Attente (Jours)</h3>
            <div class="relative h-80 w-full">
                <canvas id="avgWaitTimeChart"></canvas>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 mt-8">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Répartition par Jour de la Semaine</h3>
            <div class="relative h-80 w-full">
                <canvas id="dayOfWeekChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://ebupvceswconypqjjpcl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVidXB2Y2Vzd2NvbnlwcWpqcGNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0OTczMzQsImV4cCI6MjA4NDA3MzMzNH0.CraJSvdgLoHXWTIbnyjca4InzcNbcfPd3DbD_5U3QdU';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        let statusChart;
        let revenueChart;
        let brandRevenueChart;
        let appointmentsEvolutionChart;
        let conversionRateChart;
        let avgWaitTimeChart;
        let dayOfWeekChart;
        let allRevenueData = [];
        let allAppointmentsHistory = [];

        // Auth Check
        supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
            if (error) console.error("Erreur connexion Supabase:", error);
            else console.log("Connexion Supabase OK");
            if (!session) window.location.href = 'admin.html';
            else {
                loadChart();
                loadBrandRevenueChart();
                loadRevenueChart();
                loadAppointmentsEvolution();
                fetchSmsBalance();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'admin.html';
        });

        async function loadChart() {
            const { data, error } = await supabaseClient
                .from('appointments')
                .select('status');
            
            if (error) {
                console.error('Erreur chargement stats:', error);
                return;
            }

            const counts = { pending: 0, confirmed: 0, completed: 0, cancelled: 0 };
            data.forEach(app => {
                if (counts[app.status] !== undefined) counts[app.status]++;
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';

            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['En attente', 'Confirmé', 'Terminé', 'Annulé'],
                    datasets: [{
                        data: [counts.pending, counts.confirmed, counts.completed, counts.cancelled],
                        backgroundColor: ['#EAB308', '#16A34A', '#4B5563', '#DC2626'],
                        borderWidth: 1,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor } }
                    }
                }
            });
        }

        async function loadBrandRevenueChart() {
            const { data, error } = await supabaseClient
                .from('work_orders')
                .select('price, appointments(vehicle_brand)');

            if (error) {
                console.error('Erreur chargement revenus par marque:', error);
                return;
            }

            const revenueByBrand = {};
            data.forEach(wo => {
                if (wo.price) {
                    const brand = wo.appointments?.vehicle_brand || 'Inconnu';
                    if (!revenueByBrand[brand]) revenueByBrand[brand] = 0;
                    revenueByBrand[brand] += parseFloat(wo.price);
                }
            });

            const labels = Object.keys(revenueByBrand);
            const values = Object.values(revenueByBrand);

            const ctx = document.getElementById('brandRevenueChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';

            if (brandRevenueChart) brandRevenueChart.destroy();

            brandRevenueChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899', '#14B8A6'
                        ],
                        borderWidth: 1,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor } }
                    }
                }
            });
        }

        async function loadRevenueChart() {
            const { data, error } = await supabaseClient
                .from('work_orders')
                .select('created_at, price, deposit, payment_status')
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Erreur chargement revenus:', error);
                return;
            }

            allRevenueData = data;
            initYearFilter();
            renderRevenueChart();
            renderAppointmentsEvolutionChart();
        }

        function initYearFilter() {
            const yearFilter = document.getElementById('year-filter');
            const years = new Set();
            
            allRevenueData.forEach(wo => {
                if (wo.created_at) years.add(new Date(wo.created_at).getFullYear());
            });
            
            const currentYear = new Date().getFullYear();
            if (years.size === 0) years.add(currentYear);
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            yearFilter.innerHTML = '';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            });
            
            yearFilter.addEventListener('change', () => {
                renderRevenueChart();
                renderAppointmentsEvolutionChart();
                renderConversionRateChart();
                renderAvgWaitTimeChart();
                renderDayOfWeekChart();
            });
            document.getElementById('quarter-filter').addEventListener('change', () => {
                renderRevenueChart();
                renderAppointmentsEvolutionChart();
                renderConversionRateChart();
                renderAvgWaitTimeChart();
                renderDayOfWeekChart();
            });
        }

        function renderRevenueChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = parseInt(yearFilter.value);
            const selectedQuarter = quarterFilter.value;
            
            // Tableaux pour les données empilées (12 mois)
            const depositData = new Array(12).fill(0);
            const balanceData = new Array(12).fill(0);
            const totalBilledData = new Array(12).fill(0);
            const monthlyCounts = new Array(12).fill(0);

            allRevenueData.forEach(wo => {
                if (wo.price && wo.created_at) {
                    const date = new Date(wo.created_at);
                    if (date.getFullYear() === selectedYear) {
                        const month = date.getMonth();

                        const price = parseFloat(wo.price) || 0;
                        const deposit = wo.deposit ? parseFloat(wo.deposit) : 0;

                        totalBilledData[month] += price;
                        depositData[month] += deposit;
                        balanceData[month] += (price - deposit);
                        monthlyCounts[month]++;
                    }
                }
            });

            // Calcul Moyenne Mobile (3 mois) sur l'année complète
            const movingAverageData = new Array(12).fill(null);
            for (let i = 0; i < 12; i++) {
                if (i >= 2) {
                    const sum = totalBilledData[i] + totalBilledData[i-1] + totalBilledData[i-2];
                    movingAverageData[i] = sum / 3;
                }
            }

            // Déterminer la plage de mois à afficher
            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const displayDeposit = [];
            const displayBalance = [];
            const displayTotal = [];
            const displayMovingAverage = [];
            let displayedCount = 0;

            for(let i = startMonth; i <= endMonth; i++) {
                 labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                 displayDeposit.push(depositData[i]);
                 displayBalance.push(balanceData[i]);
                 displayTotal.push(totalBilledData[i]);
                 displayMovingAverage.push(movingAverageData[i]);
                 displayedCount += monthlyCounts[i];
            }

            const displayedTotal = displayTotal.reduce((a, b) => a + b, 0);
            document.getElementById('total-revenue').textContent = displayedTotal.toFixed(2) + ' €';

            const averageRevenue = displayedCount > 0 ? displayedTotal / displayedCount : 0;
            const avgEl = document.getElementById('average-revenue');
            if (avgEl) avgEl.textContent = averageRevenue.toFixed(2) + ' €';

            const tableBody = document.getElementById('revenue-table-body');
            tableBody.innerHTML = '';
            displayTotal.forEach((amount, index) => {
                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white capitalize">${labels[index]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 text-right">${amount.toFixed(2)} €</td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            const ctx = document.getElementById('revenueChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Moyenne mobile (3 mois)',
                            data: displayMovingAverage,
                            type: 'line',
                            borderColor: '#8B5CF6', // Violet
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Acomptes',
                            data: displayDeposit,
                            backgroundColor: '#F59E0B', // Jaune/Orange
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Solde (Prix - Acompte)',
                            data: displayBalance,
                            backgroundColor: '#3B82F6', // Bleu
                            stack: 'Stack 0',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const totalForMonth = displayTotal[context.dataIndex];
                                    
                                    let percentageString = '';
                                    if (totalForMonth > 0 && value > 0 && context.dataset.type !== 'line') {
                                        const percentage = (value / totalForMonth) * 100;
                                        percentageString = ` (${percentage.toFixed(1)}%)`;
                                    }

                                    return `${label}: ${value.toFixed(2)} €${percentageString}`;
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        if (tooltipItem.dataset.type !== 'line') {
                                            sum += tooltipItem.parsed.y;
                                        }
                                    });
                                    return 'Total facturé: ' + sum.toFixed(2) + ' €';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            stacked: true,
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadAppointmentsEvolution() {
            const { data, error } = await supabaseClient
                .from('appointments')
                .select('created_at, status, requested_date');

            if (error) {
                console.error('Erreur chargement historique rdv:', error);
                return;
            }

            allAppointmentsHistory = data;
            renderAppointmentsEvolutionChart();
            renderConversionRateChart();
            renderAvgWaitTimeChart();
            renderDayOfWeekChart();
        }

        function renderAppointmentsEvolutionChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            const countsByMonth = new Array(12).fill(0);

            allAppointmentsHistory.forEach(app => {
                const date = new Date(app.created_at);
                if (date.getFullYear() === selectedYear) {
                    countsByMonth[date.getMonth()]++;
                }
            });

            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const data = [];

            for (let i = startMonth; i <= endMonth; i++) {
                labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                data.push(countsByMonth[i]);
            }

            const ctx = document.getElementById('appointmentsEvolutionChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (appointmentsEvolutionChart) appointmentsEvolutionChart.destroy();

            appointmentsEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de Rendez-vous',
                        data: data,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor, stepSize: 1 }, 
                            grid: { color: gridColor } 
                        },
                        x: { 
                            ticks: { color: textColor }, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }

        function renderConversionRateChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            const totalByMonth = new Array(12).fill(0);
            const completedByMonth = new Array(12).fill(0);

            allAppointmentsHistory.forEach(app => {
                const date = new Date(app.created_at);
                if (date.getFullYear() === selectedYear) {
                    const month = date.getMonth();
                    totalByMonth[month]++;
                    if (app.status === 'completed') {
                        completedByMonth[month]++;
                    }
                }
            });

            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const data = [];

            for (let i = startMonth; i <= endMonth; i++) {
                labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                const total = totalByMonth[i];
                const completed = completedByMonth[i];
                const rate = total === 0 ? 0 : (completed / total) * 100;
                data.push(rate.toFixed(1));
            }

            const ctx = document.getElementById('conversionRateChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (conversionRateChart) conversionRateChart.destroy();

            conversionRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taux de Conversion (%)',
                        data: data,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { color: textColor }, 
                            grid: { color: gridColor } 
                        },
                        x: { 
                            ticks: { color: textColor }, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }

        function renderAvgWaitTimeChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            const waitTimeByMonth = new Array(12).fill(0);
            const countByMonth = new Array(12).fill(0);

            allAppointmentsHistory.forEach(app => {
                if (app.created_at && app.requested_date) {
                    const created = new Date(app.created_at);
                    const requested = new Date(app.requested_date);
                    
                    if (created.getFullYear() === selectedYear) {
                        const month = created.getMonth();
                        const diffTime = requested - created;
                        const diffDays = diffTime / (1000 * 60 * 60 * 24);
                        
                        if (diffDays >= 0) {
                            waitTimeByMonth[month] += diffDays;
                            countByMonth[month]++;
                        }
                    }
                }
            });

            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const data = [];

            for (let i = startMonth; i <= endMonth; i++) {
                labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                const avg = countByMonth[i] > 0 ? (waitTimeByMonth[i] / countByMonth[i]) : 0;
                data.push(avg.toFixed(1));
            }

            const ctx = document.getElementById('avgWaitTimeChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (avgWaitTimeChart) avgWaitTimeChart.destroy();

            avgWaitTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Délai Moyen (Jours)',
                        data: data,
                        backgroundColor: 'rgba(245, 158, 11, 0.6)', // Orange
                        borderColor: '#F59E0B',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        }

        function renderDayOfWeekChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            // 0=Lundi, ..., 6=Dimanche
            const counts = new Array(7).fill(0);

            allAppointmentsHistory.forEach(app => {
                if (app.requested_date) {
                    const date = new Date(app.requested_date);
                    if (date.getFullYear() === selectedYear) {
                        const month = date.getMonth();
                        
                        if (selectedQuarter !== 'all') {
                            const q = parseInt(selectedQuarter);
                            const qStart = (q - 1) * 3;
                            const qEnd = qStart + 2;
                            if (month < qStart || month > qEnd) return;
                        }

                        let day = date.getDay(); // 0 (Dim) à 6 (Sam)
                        // Conversion pour avoir 0=Lundi ... 6=Dimanche
                        let index = day === 0 ? 6 : day - 1;
                        counts[index]++;
                    }
                }
            });

            const labels = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const ctx = document.getElementById('dayOfWeekChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (dayOfWeekChart) dayOfWeekChart.destroy();

            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rendez-vous',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // Bleu
                        borderColor: '#3B82F6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        }

        async function fetchSmsBalance() {
            const container = document.getElementById('sms-balance-container');
            const span = document.getElementById('sms-balance');

            try {
                const { data, error } = await supabaseClient.functions.invoke('getBalance', {
                    headers: {
                        Authorization: `Bearer ${supabaseKey}`
                    }
                });

                if (error) throw error;
                
                console.log('Solde SMS reçu:', data);

                if (data && (data.balance !== undefined || data.amount !== undefined || data.solde !== undefined)) {
                    const balance = data.balance || data.amount || data.solde;
                    const currency = data.currency || data.devise || '€';
                    
                    span.textContent = `${parseFloat(balance).toFixed(2)} ${currency}`;
                    container.classList.remove('hidden');

                    if (parseFloat(balance) < 5) {
                        container.classList.remove('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                        container.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                    } else {
                        container.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                        container.classList.remove('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                    }
                }
            } catch (err) {
                console.error('Erreur récupération solde SMS:', err);
                if (container && span) {
                    container.classList.remove('hidden');
                    span.textContent = "Err";
                }
            }
        }
    </script>
</body>
</html>