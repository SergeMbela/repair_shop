<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques - AutoExpert</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Configuration -->
    <script src="config.js"></script>
    <link rel="manifest" href="manifest.json">
    <script>
        tailwind.config = { darkMode: 'class' }
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen font-sans">

    <nav class="bg-white dark:bg-gray-800 shadow mb-8">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <span class="font-bold text-xl text-blue-600 truncate">AutoExpert <span class="text-gray-600 dark:text-gray-300 text-sm hidden sm:inline">| Statistiques</span></span>
            
            <!-- Desktop Menu -->
            <div class="hidden md:flex items-center space-x-4">
                <div id="sms-balance-container" class="hidden px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium dark:bg-blue-900 dark:text-blue-200 flex items-center" title="Crédit SMS restant">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="sms-balance">--</span>
                </div>
                <a href="admin.html" class="text-sm text-gray-500 hover:text-blue-600">Planning</a>
                <a href="work_orders.html" class="text-sm text-gray-500 hover:text-blue-600">Fiches de travail</a>
                <a href="stats.html" class="text-sm text-blue-600 font-bold bg-blue-50 dark:bg-gray-700 rounded-md px-2 py-1">Statistiques</a>
                <a href="index.html" class="text-sm text-gray-500 hover:text-blue-600">Voir le site</a>
                <a href="settings.html" class="text-sm text-gray-500 hover:text-blue-600">Paramètres</a>
                <button id="install-pwa-btn" class="hidden text-sm text-green-600 hover:text-green-800 font-medium border border-green-600 rounded px-2 py-1 hover:bg-green-50 transition">Installer App</button>
                <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none rounded-lg text-sm p-2.5">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">Déconnexion</button>
            </div>

            <!-- Mobile Menu Button -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-btn" class="text-gray-500 hover:text-blue-600 focus:outline-none p-2">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
            <div class="px-4 py-3 space-y-1">
                <div id="sms-balance-container-mobile" class="hidden mb-3 px-3 py-2 bg-blue-100 text-blue-800 rounded-md text-sm font-medium dark:bg-blue-900 dark:text-blue-200 flex items-center w-fit">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="sms-balance-mobile">--</span>
                </div>
                <a href="admin.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Planning</a>
                <a href="work_orders.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Fiches de travail</a>
                <a href="stats.html" class="block px-3 py-2 rounded-md text-base font-bold text-blue-600 bg-blue-50 dark:bg-gray-700 dark:text-white">Statistiques</a>
                <a href="index.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Voir le site</a>
                <a href="settings.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Paramètres</a>
                <button id="mobile-install-pwa-btn" class="hidden w-full text-left block px-3 py-2 rounded-md text-base font-medium text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20">Installer App</button>
                <button id="mobile-theme-toggle" class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Mode Sombre / Clair</button>
                <button id="logout-btn-mobile" class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">Déconnexion</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 pb-12">
        <!-- Fil d'ariane -->
        <nav class="flex mb-6" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-1 md:space-x-3">
                <li class="inline-flex items-center">
                    <a href="admin.html" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                        <svg class="w-3 h-3 mr-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="m19.707 9.293-2-2-7-7a1 1 0 0 0-1.414 0l-7 7-2 2a1 1 0 0 0 1.414 1.414L2 10.414V18a2 2 0 0 0 2 2h3a1 1 0 0 0 1-1v-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v4a1 1 0 0 0 1 1h3a2 2 0 0 0 2-2v-7.586l.293.293a1 1 0 0 0 1.414-1.414Z"/>
                        </svg>
                        Administration
                    </a>
                </li>
                <li aria-current="page">
                    <div class="flex items-center">
                        <svg class="w-3 h-3 text-gray-400 mx-1" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 9 4-4-4-4"/></svg>
                        <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">Statistiques</span>
                    </div>
                </li>
            </ol>
        </nav>

        <div id="stats-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Bloc 1: Statut -->
            <div id="block-status" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 cursor-move" draggable="true">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Statistiques des Rendez-vous</h3>
                <div class="relative h-80 w-full">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <!-- Bloc 2: Revenus Marque -->
            <div id="block-brand" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 cursor-move" draggable="true">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Revenus par Marque</h3>
                <div class="relative h-80 w-full">
                    <canvas id="brandRevenueChart"></canvas>
                </div>
            </div>

            <!-- Bloc 3: Revenus Mensuels -->
            <div id="block-revenue" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Revenus Mensuels (€)</h3>
                        <div class="flex flex-col sm:flex-row sm:gap-6 mt-1">
                            <p class="text-sm text-gray-500 dark:text-gray-400">Total : <span id="total-revenue" class="font-bold text-2xl text-blue-600 dark:text-blue-400">0.00 €</span></p>
                            <p class="text-sm text-gray-500 dark:text-gray-400 flex items-center">Panier moyen : <span id="average-revenue" class="font-bold text-xl text-green-600 dark:text-green-400 ml-2">0.00 €</span></p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <select id="quarter-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            <option value="all">Toute l'année</option>
                            <option value="1">Q1 (Jan-Mar)</option>
                            <option value="2">Q2 (Avr-Juin)</option>
                            <option value="3">Q3 (Juil-Sept)</option>
                            <option value="4">Q4 (Oct-Déc)</option>
                        </select>
                        <select id="year-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                    </div>
                </div>
                <div class="relative h-80 w-full">
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="mt-8 overflow-hidden border border-gray-200 dark:border-gray-700 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Mois</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Revenu</th>
                            </tr>
                        </thead>
                        <tbody id="revenue-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
            </div>

            <!-- Bloc 4: Évolution RDV -->
            <div id="block-evolution" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Évolution des Prises de Rendez-vous</h3>
            <div class="relative h-80 w-full">
                <canvas id="appointmentsEvolutionChart"></canvas>
            </div>
        </div>

            <!-- Bloc 5: Taux Conversion -->
            <div id="block-conversion" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Taux de Conversion Mensuel (%)</h3>
            <div class="relative h-80 w-full">
                <canvas id="conversionRateChart"></canvas>
            </div>
        </div>

            <!-- Bloc 6: Délai Moyen -->
            <div id="block-wait" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Délai Moyen d'Attente (Jours)</h3>
            <div class="relative h-80 w-full">
                <canvas id="avgWaitTimeChart"></canvas>
            </div>
        </div>

            <!-- Bloc 7: Jours Semaine -->
            <div id="block-day" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Répartition par Jour de la Semaine</h3>
            <div class="relative h-80 w-full">
                <canvas id="dayOfWeekChart"></canvas>
            </div>
        </div>

            <!-- Bloc 8: Respect Délais -->
            <div id="block-deadline" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Respect des Délais (Sortie Prévue vs Réelle)</h3>
                <div class="flex gap-2 mt-2 sm:mt-0">
                    <input type="month" id="deadline-month-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" title="Filtrer par mois">
                    <button onclick="loadDeadlineComplianceChart()" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition">Filtrer</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="relative h-64 w-full">
                    <canvas id="deadlineComplianceChart"></canvas>
                </div>
                <div class="flex flex-col justify-center space-y-4">
                    <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg border border-green-100 dark:border-green-800">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Taux de respect</p>
                        <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="compliance-rate">-- %</p>
                        <p class="text-xs mt-1 hidden" id="compliance-trend"></p>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900/30 p-4 rounded-lg border border-red-100 dark:border-red-800">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Retard moyen (si retard)</p>
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400" id="avg-delay">-- min</p>
                    </div>
                </div>
            </div>
            <div id="late-vehicles-list" class="mt-6 hidden border-t border-gray-200 dark:border-gray-700 pt-4"></div>
        </div>

            <!-- Bloc 11: Répartition Mécaniciens -->
            <div id="block-mechanics" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Répartition des Fiches par Mécanicien</h3>
                <div class="relative h-80 w-full">
                    <canvas id="mechanicsChart"></canvas>
                </div>
            </div>

            <!-- Bloc 9: Messages Envoyés -->
            <div id="block-messages" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Messages Envoyés</h3>
                <div class="flex gap-2 mt-2 sm:mt-0">
                    <input type="date" id="msg-start-date" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" title="Date de début">
                    <input type="date" id="msg-end-date" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" title="Date de fin">
                    <button onclick="loadMessagesChart()" class="px-3 py-1 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 transition">Filtrer</button>
                </div>
            </div>
            <div class="relative h-80 w-full">
                <canvas id="messagesChart"></canvas>
            </div>
        </div>

            <!-- Bloc 10: Historique Messages -->
            <div id="block-history" class="draggable-item bg-white dark:bg-gray-800 rounded-lg shadow p-6 lg:col-span-2 cursor-move" draggable="true">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Historique des Derniers Messages</h3>
                <div class="flex gap-2 mt-2 sm:mt-0">
                    <select id="msg-status-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Tous les statuts</option>
                        <option value="sent">Envoyé</option>
                        <option value="failed">Échec</option>
                    </select>
                    <select id="msg-channel-filter" class="px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="">Tous les canaux</option>
                        <option value="sms">SMS</option>
                        <option value="email">Email</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Date</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Client</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Canal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Statut</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Message</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="messages-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
            </div>
            <!-- Pagination Messages -->
            <div id="msg-pagination" class="mt-4 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 pt-4 hidden">
                <div class="flex-1 flex justify-between sm:hidden">
                    <button id="msg-prev-page-mobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Précédent</button>
                    <button id="msg-next-page-mobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">Suivant</button>
                </div>
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <p class="text-sm text-gray-700 dark:text-gray-300">
                            Affichage de <span class="font-medium" id="msg-page-start">1</span> à <span class="font-medium" id="msg-page-end">10</span> sur <span class="font-medium" id="msg-total-count">20</span> résultats
                        </p>
                    </div>
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="msg-prev-page" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <span class="sr-only">Précédent</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="msg-next-page" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <span class="sr-only">Suivant</span>
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Resend Message Modal -->
    <div id="resend-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true" id="resend-overlay"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Renvoyer le message</h3>
                    <input type="hidden" id="resend-msg-id">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Contenu du message</label>
                        <textarea id="resend-msg-body" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></textarea>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        <p>Destinataire : <span id="resend-client-name" class="font-medium"></span></p>
                        <p>Canal : <span id="resend-channel" class="font-medium"></span></p>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-resend-btn" onclick="confirmResend()" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">Envoyer</button>
                    <button type="button" onclick="closeResendModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-500">Annuler</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-5 left-1/2 -translate-x-1/2 max-w-sm w-full bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <span id="toast-message" class="flex-grow pr-2"></span>
            <button id="toast-close-btn" class="ml-2 p-1 rounded-md hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white">
                <span class="sr-only">Fermer</span>
                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        const supabaseUrl = window.CONFIG.SUPABASE_URL;
        const supabaseKey = window.CONFIG.SUPABASE_KEY;
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        let statusChart;
        let revenueChart;
        let brandRevenueChart;
        let appointmentsEvolutionChart;
        let conversionRateChart;
        let avgWaitTimeChart;
        let dayOfWeekChart;
        let deadlineComplianceChart;
        let mechanicsChart;
        let messagesChart;
        let allRevenueData = [];
        let allAppointmentsHistory = [];
        let currentMsgPage = 1;
        const msgItemsPerPage = 10;
        let toastTimeout;

        // Signature Email par défaut
        const emailSignature = `
            <br><br>
            <div style="border-top: 1px solid #e5e7eb; padding-top: 15px; font-family: Arial, sans-serif;">
                <strong style="color: #2563eb;">AutoExpert</strong><br>
                <span style="font-size: 12px; color: #6b7280;">
                    123 Avenue de la Mécanique, 1000 Bruxelles<br>
                    Tél: 02 123 45 67 | Email: <a href="mailto:contact@autoexpert.be" style="color: #2563eb; text-decoration: none;">contact@autoexpert.be</a><br>
                    <a href="#" style="color: #2563eb; text-decoration: none;">www.autoexpert.be</a>
                </span>
            </div>`;

        // Auth Check
        supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
            if (error) console.error("Erreur connexion Supabase:", error);
            else console.log("Connexion Supabase OK");
            if (!session) window.location.href = 'admin.html';
            else {
                loadChart();
                loadBrandRevenueChart();
                loadRevenueChart();
                loadAppointmentsEvolution();
                loadDeadlineComplianceChart();
                loadMechanicStats();
                loadMessagesChart();
                loadMessagesHistoryTable();
                fetchSmsBalance();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'admin.html';
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        if (logoutBtnMobile) {
            logoutBtnMobile.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'admin.html';
            });
        }

        async function loadChart() {
            const { data, error } = await supabaseClient
                .from('appointments')
                .select('status');
            
            if (error) {
                console.error('Erreur chargement stats:', error);
                return;
            }

            const counts = { pending: 0, confirmed: 0, completed: 0, cancelled: 0 };
            data.forEach(app => {
                if (counts[app.status] !== undefined) counts[app.status]++;
            });

            const ctx = document.getElementById('statusChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';

            if (statusChart) statusChart.destroy();

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['En attente', 'Confirmé', 'Terminé', 'Annulé'],
                    datasets: [{
                        data: [counts.pending, counts.confirmed, counts.completed, counts.cancelled],
                        backgroundColor: ['#EAB308', '#16A34A', '#4B5563', '#DC2626'],
                        borderWidth: 1,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor } }
                    }
                }
            });
        }

        async function loadBrandRevenueChart() {
            const { data, error } = await supabaseClient
                .from('work_orders')
                .select('price, appointments(vehicle_brand)');

            if (error) {
                console.error('Erreur chargement revenus par marque:', error);
                return;
            }

            const revenueByBrand = {};
            data.forEach(wo => {
                if (wo.price) {
                    const brand = wo.appointments?.vehicle_brand || 'Inconnu';
                    if (!revenueByBrand[brand]) revenueByBrand[brand] = 0;
                    revenueByBrand[brand] += parseFloat(wo.price);
                }
            });

            const labels = Object.keys(revenueByBrand);
            const values = Object.values(revenueByBrand);

            const ctx = document.getElementById('brandRevenueChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';

            if (brandRevenueChart) brandRevenueChart.destroy();

            brandRevenueChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#6366F1', '#8B5CF6', '#EC4899', '#14B8A6'
                        ],
                        borderWidth: 1,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor } }
                    }
                }
            });
        }

        async function loadRevenueChart() {
            const { data, error } = await supabaseClient
                .from('work_orders')
                .select('created_at, price, deposit, payment_status')
                .order('created_at', { ascending: true });

            if (error) {
                console.error('Erreur chargement revenus:', error);
                return;
            }

            allRevenueData = data;
            initYearFilter();
            renderRevenueChart();
            renderAppointmentsEvolutionChart();
        }

        function initYearFilter() {
            const yearFilter = document.getElementById('year-filter');
            const years = new Set();
            
            allRevenueData.forEach(wo => {
                if (wo.created_at) years.add(new Date(wo.created_at).getFullYear());
            });
            
            const currentYear = new Date().getFullYear();
            if (years.size === 0) years.add(currentYear);
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            
            yearFilter.innerHTML = '';
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearFilter.appendChild(option);
            });
            
            yearFilter.addEventListener('change', () => {
                renderRevenueChart();
                renderAppointmentsEvolutionChart();
                renderConversionRateChart();
                renderAvgWaitTimeChart();
                renderDayOfWeekChart();
            });
            document.getElementById('quarter-filter').addEventListener('change', () => {
                renderRevenueChart();
                renderAppointmentsEvolutionChart();
                renderConversionRateChart();
                renderAvgWaitTimeChart();
                renderDayOfWeekChart();
            });
        }

        function renderRevenueChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = parseInt(yearFilter.value);
            const selectedQuarter = quarterFilter.value;
            
            // Tableaux pour les données empilées (12 mois)
            const depositData = new Array(12).fill(0);
            const balanceData = new Array(12).fill(0);
            const totalBilledData = new Array(12).fill(0);
            const monthlyCounts = new Array(12).fill(0);

            allRevenueData.forEach(wo => {
                if (wo.price && wo.created_at) {
                    const date = new Date(wo.created_at);
                    if (date.getFullYear() === selectedYear) {
                        const month = date.getMonth();

                        const price = parseFloat(wo.price) || 0;
                        const deposit = wo.deposit ? parseFloat(wo.deposit) : 0;

                        totalBilledData[month] += price;
                        depositData[month] += deposit;
                        balanceData[month] += (price - deposit);
                        monthlyCounts[month]++;
                    }
                }
            });

            // Calcul Moyenne Mobile (3 mois) sur l'année complète
            const movingAverageData = new Array(12).fill(null);
            for (let i = 0; i < 12; i++) {
                if (i >= 2) {
                    const sum = totalBilledData[i] + totalBilledData[i-1] + totalBilledData[i-2];
                    movingAverageData[i] = sum / 3;
                }
            }

            // Déterminer la plage de mois à afficher
            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const displayDeposit = [];
            const displayBalance = [];
            const displayTotal = [];
            const displayMovingAverage = [];
            let displayedCount = 0;

            for(let i = startMonth; i <= endMonth; i++) {
                 labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                 displayDeposit.push(depositData[i]);
                 displayBalance.push(balanceData[i]);
                 displayTotal.push(totalBilledData[i]);
                 displayMovingAverage.push(movingAverageData[i]);
                 displayedCount += monthlyCounts[i];
            }

            const displayedTotal = displayTotal.reduce((a, b) => a + b, 0);
            document.getElementById('total-revenue').textContent = displayedTotal.toFixed(2) + ' €';

            const averageRevenue = displayedCount > 0 ? displayedTotal / displayedCount : 0;
            const avgEl = document.getElementById('average-revenue');
            if (avgEl) avgEl.textContent = averageRevenue.toFixed(2) + ' €';

            const tableBody = document.getElementById('revenue-table-body');
            tableBody.innerHTML = '';
            displayTotal.forEach((amount, index) => {
                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white capitalize">${labels[index]}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300 text-right">${amount.toFixed(2)} €</td>
                    </tr>`;
                tableBody.insertAdjacentHTML('beforeend', row);
            });

            const ctx = document.getElementById('revenueChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (revenueChart) revenueChart.destroy();

            revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Moyenne mobile (3 mois)',
                            data: displayMovingAverage,
                            type: 'line',
                            borderColor: '#8B5CF6', // Violet
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4
                        },
                        {
                            label: 'Acomptes',
                            data: displayDeposit,
                            backgroundColor: '#F59E0B', // Jaune/Orange
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Solde (Prix - Acompte)',
                            data: displayBalance,
                            backgroundColor: '#3B82F6', // Bleu
                            stack: 'Stack 0',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'bottom',
                            labels: { color: textColor }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    const totalForMonth = displayTotal[context.dataIndex];
                                    
                                    let percentageString = '';
                                    if (totalForMonth > 0 && value > 0 && context.dataset.type !== 'line') {
                                        const percentage = (value / totalForMonth) * 100;
                                        percentageString = ` (${percentage.toFixed(1)}%)`;
                                    }

                                    return `${label}: ${value.toFixed(2)} €${percentageString}`;
                                },
                                footer: function(tooltipItems) {
                                    let sum = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        if (tooltipItem.dataset.type !== 'line') {
                                            sum += tooltipItem.parsed.y;
                                        }
                                    });
                                    return 'Total facturé: ' + sum.toFixed(2) + ' €';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: { color: textColor },
                            grid: { color: gridColor }
                        },
                        x: {
                            stacked: true,
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        async function loadAppointmentsEvolution() {
            const { data, error } = await supabaseClient
                .from('appointments')
                .select('created_at, status, requested_date');

            if (error) {
                console.error('Erreur chargement historique rdv:', error);
                return;
            }

            allAppointmentsHistory = data;
            renderAppointmentsEvolutionChart();
            renderConversionRateChart();
            renderAvgWaitTimeChart();
            renderDayOfWeekChart();
        }

        function renderAppointmentsEvolutionChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            const countsByMonth = new Array(12).fill(0);

            allAppointmentsHistory.forEach(app => {
                const date = new Date(app.created_at);
                if (date.getFullYear() === selectedYear) {
                    countsByMonth[date.getMonth()]++;
                }
            });

            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const data = [];

            for (let i = startMonth; i <= endMonth; i++) {
                labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                data.push(countsByMonth[i]);
            }

            const ctx = document.getElementById('appointmentsEvolutionChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (appointmentsEvolutionChart) appointmentsEvolutionChart.destroy();

            appointmentsEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de Rendez-vous',
                        data: data,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor, stepSize: 1 }, 
                            grid: { color: gridColor } 
                        },
                        x: { 
                            ticks: { color: textColor }, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }

        function renderConversionRateChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            const totalByMonth = new Array(12).fill(0);
            const completedByMonth = new Array(12).fill(0);

            allAppointmentsHistory.forEach(app => {
                const date = new Date(app.created_at);
                if (date.getFullYear() === selectedYear) {
                    const month = date.getMonth();
                    totalByMonth[month]++;
                    if (app.status === 'completed') {
                        completedByMonth[month]++;
                    }
                }
            });

            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const data = [];

            for (let i = startMonth; i <= endMonth; i++) {
                labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                const total = totalByMonth[i];
                const completed = completedByMonth[i];
                const rate = total === 0 ? 0 : (completed / total) * 100;
                data.push(rate.toFixed(1));
            }

            const ctx = document.getElementById('conversionRateChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (conversionRateChart) conversionRateChart.destroy();

            conversionRateChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Taux de Conversion (%)',
                        data: data,
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { 
                            mode: 'index', 
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y + '%';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 100,
                            ticks: { color: textColor }, 
                            grid: { color: gridColor } 
                        },
                        x: { 
                            ticks: { color: textColor }, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }

        function renderAvgWaitTimeChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            const waitTimeByMonth = new Array(12).fill(0);
            const countByMonth = new Array(12).fill(0);

            allAppointmentsHistory.forEach(app => {
                if (app.created_at && app.requested_date) {
                    const created = new Date(app.created_at);
                    const requested = new Date(app.requested_date);
                    
                    if (created.getFullYear() === selectedYear) {
                        const month = created.getMonth();
                        const diffTime = requested - created;
                        const diffDays = diffTime / (1000 * 60 * 60 * 24);
                        
                        if (diffDays >= 0) {
                            waitTimeByMonth[month] += diffDays;
                            countByMonth[month]++;
                        }
                    }
                }
            });

            let startMonth = 0;
            let endMonth = 11;
            if (selectedQuarter !== 'all') {
                const q = parseInt(selectedQuarter);
                startMonth = (q - 1) * 3;
                endMonth = startMonth + 2;
            }

            const labels = [];
            const data = [];

            for (let i = startMonth; i <= endMonth; i++) {
                labels.push(new Date(selectedYear, i, 1).toLocaleDateString('fr-FR', { month: 'long' }));
                const avg = countByMonth[i] > 0 ? (waitTimeByMonth[i] / countByMonth[i]) : 0;
                data.push(avg.toFixed(1));
            }

            const ctx = document.getElementById('avgWaitTimeChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (avgWaitTimeChart) avgWaitTimeChart.destroy();

            avgWaitTimeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Délai Moyen (Jours)',
                        data: data,
                        backgroundColor: 'rgba(245, 158, 11, 0.6)', // Orange
                        borderColor: '#F59E0B',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        }

        function renderDayOfWeekChart() {
            const yearFilter = document.getElementById('year-filter');
            const quarterFilter = document.getElementById('quarter-filter');
            const selectedYear = yearFilter.value ? parseInt(yearFilter.value) : new Date().getFullYear();
            const selectedQuarter = quarterFilter.value;

            // 0=Lundi, ..., 6=Dimanche
            const counts = new Array(7).fill(0);

            allAppointmentsHistory.forEach(app => {
                if (app.requested_date) {
                    const date = new Date(app.requested_date);
                    if (date.getFullYear() === selectedYear) {
                        const month = date.getMonth();
                        
                        if (selectedQuarter !== 'all') {
                            const q = parseInt(selectedQuarter);
                            const qStart = (q - 1) * 3;
                            const qEnd = qStart + 2;
                            if (month < qStart || month > qEnd) return;
                        }

                        let day = date.getDay(); // 0 (Dim) à 6 (Sam)
                        // Conversion pour avoir 0=Lundi ... 6=Dimanche
                        let index = day === 0 ? 6 : day - 1;
                        counts[index]++;
                    }
                }
            });

            const labels = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche'];
            const ctx = document.getElementById('dayOfWeekChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (dayOfWeekChart) dayOfWeekChart.destroy();

            dayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Rendez-vous',
                        data: counts,
                        backgroundColor: 'rgba(59, 130, 246, 0.6)', // Bleu
                        borderColor: '#3B82F6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1 }, grid: { color: gridColor } },
                        x: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            });
        }

        async function loadDeadlineComplianceChart() {
            const monthFilter = document.getElementById('deadline-month-filter').value;

            let query = supabaseClient
                .from('work_orders')
                .select('scheduled_release_datetime, actual_release_datetime, registration_number, appointments(full_name, vehicle_brand, vehicle_model)')
                .not('scheduled_release_datetime', 'is', null)
                .not('actual_release_datetime', 'is', null);

            if (monthFilter) {
                const [year, month] = monthFilter.split('-');
                const lastDay = new Date(year, month, 0).getDate();
                const startDate = `${monthFilter}-01T00:00:00`;
                const endDate = `${monthFilter}-${lastDay}T23:59:59`;
                query = query.gte('scheduled_release_datetime', startDate).lte('scheduled_release_datetime', endDate);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Erreur chargement délais:', error);
                return;
            }

            let onTime = 0;
            let late = 0;
            let totalDelayMinutes = 0;
            const lateVehicles = [];

            data.forEach(wo => {
                const scheduled = new Date(wo.scheduled_release_datetime);
                const actual = new Date(wo.actual_release_datetime);
                
                if (actual <= scheduled) {
                    onTime++;
                } else {
                    late++;
                    const diffMs = actual - scheduled;
                    totalDelayMinutes += Math.floor(diffMs / 60000);
                    
                    lateVehicles.push({
                        client: wo.appointments?.full_name || 'Inconnu',
                        vehicle: `${wo.appointments?.vehicle_brand || ''} ${wo.appointments?.vehicle_model || ''}`.trim(),
                        plate: wo.registration_number || '',
                        scheduled: scheduled,
                        actual: actual,
                        delay: Math.floor(diffMs / 60000)
                    });
                }
            });

            const total = onTime + late;
            const rate = total > 0 ? ((onTime / total) * 100).toFixed(1) : 0;
            const avgDelay = late > 0 ? Math.round(totalDelayMinutes / late) : 0;

            let avgDelayStr = avgDelay + ' min';
            if (avgDelay > 60) {
                const h = Math.floor(avgDelay / 60);
                const m = avgDelay % 60;
                avgDelayStr = `${h}h ${m}min`;
            }

            document.getElementById('compliance-rate').textContent = rate + ' %';
            document.getElementById('avg-delay').textContent = avgDelayStr;

            // Calcul de la tendance (si filtre mois actif)
            const trendEl = document.getElementById('compliance-trend');
            if (monthFilter) {
                const [year, month] = monthFilter.split('-').map(Number);
                const prevDate = new Date(year, month - 2, 1); // Mois précédent
                const prevYear = prevDate.getFullYear();
                const prevMonth = prevDate.getMonth() + 1;
                const prevMonthStr = `${prevYear}-${prevMonth.toString().padStart(2, '0')}`;
                const lastDayPrev = new Date(prevYear, prevMonth, 0).getDate();
                
                const { data: prevData } = await supabaseClient
                    .from('work_orders')
                    .select('scheduled_release_datetime, actual_release_datetime')
                    .gte('scheduled_release_datetime', `${prevMonthStr}-01T00:00:00`)
                    .lte('scheduled_release_datetime', `${prevMonthStr}-${lastDayPrev}T23:59:59`)
                    .not('scheduled_release_datetime', 'is', null)
                    .not('actual_release_datetime', 'is', null);

                if (prevData && prevData.length > 0) {
                    let prevOnTime = 0;
                    prevData.forEach(wo => {
                        if (new Date(wo.actual_release_datetime) <= new Date(wo.scheduled_release_datetime)) prevOnTime++;
                    });
                    const prevRate = (prevOnTime / prevData.length) * 100;
                    const currentRateNum = parseFloat(rate);
                    const diff = currentRateNum - prevRate;
                    const icon = diff >= 0 ? '▲' : '▼';
                    const color = diff >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                    
                    trendEl.innerHTML = `<span class="${color} font-bold">${icon} ${Math.abs(diff).toFixed(1)}%</span> vs mois précédent`;
                    trendEl.classList.remove('hidden');
                } else {
                    trendEl.innerHTML = `<span class="text-gray-400">Pas de données mois préc.</span>`;
                    trendEl.classList.remove('hidden');
                }
            } else {
                trendEl.classList.add('hidden');
            }

            const ctx = document.getElementById('deadlineComplianceChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';

            if (deadlineComplianceChart) deadlineComplianceChart.destroy();

            deadlineComplianceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['À l\'heure', 'En retard'],
                    datasets: [{
                        data: [onTime, late],
                        backgroundColor: ['#10B981', '#EF4444'],
                        borderWidth: 1,
                        borderColor: isDark ? '#1f2937' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: textColor } }
                    }
                }
            });

            // Affichage de la liste des retards
            const listContainer = document.getElementById('late-vehicles-list');
            if (lateVehicles.length > 0) {
                let html = '<h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-4">Détail des retards</h4><div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-700"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Client</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Véhicule</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Prévu</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Réel</th><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Retard</th></tr></thead><tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">';
                
                lateVehicles.sort((a, b) => b.delay - a.delay).forEach(v => {
                    let delayStr = v.delay + ' min';
                    if (v.delay > 60) {
                        const h = Math.floor(v.delay / 60);
                        const m = v.delay % 60;
                        delayStr = `${h}h ${m}min`;
                    }
                    
                    const scheduledStr = v.scheduled.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });
                    const actualStr = v.actual.toLocaleString('fr-FR', { dateStyle: 'short', timeStyle: 'short' });

                    html += `<tr>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900 dark:text-white font-medium">${v.client}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${v.vehicle} <span class="text-xs text-gray-400">(${v.plate})</span></td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${scheduledStr}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 dark:text-red-400 font-medium">${actualStr}</td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-red-600 dark:text-red-400 font-bold">${delayStr}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
                listContainer.innerHTML = html;
                listContainer.classList.remove('hidden');
            } else {
                listContainer.innerHTML = '';
                listContainer.classList.add('hidden');
            }
        }

        async function loadMechanicStats() {
            const { data, error } = await supabaseClient
                .from('work_orders')
                .select('id, work_order_mechanics(mechanics(first_name, last_name))');

            if (error) {
                console.error('Erreur chargement stats mécaniciens:', error);
                return;
            }

            const counts = {};
            let unassignedCount = 0;

            data.forEach(wo => {
                if (wo.work_order_mechanics && wo.work_order_mechanics.length > 0) {
                    wo.work_order_mechanics.forEach(rel => {
                        if (rel.mechanics) {
                            const name = `${rel.mechanics.first_name} ${rel.mechanics.last_name}`;
                            counts[name] = (counts[name] || 0) + 1;
                        }
                    });
                } else {
                    unassignedCount++;
                }
            });

            if (unassignedCount > 0) {
                counts['Non assigné'] = unassignedCount;
            }

            const labels = Object.keys(counts);
            const values = Object.values(counts);

            const ctx = document.getElementById('mechanicsChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (mechanicsChart) mechanicsChart.destroy();

            mechanicsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Fiches de travail',
                        data: values,
                        backgroundColor: 'rgba(99, 102, 241, 0.6)', // Indigo
                        borderColor: '#6366F1',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { color: textColor, stepSize: 1 }, 
                            grid: { color: gridColor } 
                        },
                        x: { 
                            ticks: { color: textColor }, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }

        async function loadMessagesChart() {
            const startDate = document.getElementById('msg-start-date').value;
            const endDate = document.getElementById('msg-end-date').value;

            let query = supabaseClient
                .from('daily_message_stats')
                .select('*')
                .order('day', { ascending: true });

            if (startDate) query = query.gte('day', startDate);
            if (endDate) query = query.lte('day', endDate);
            
            // Par défaut, limiter aux 30 derniers jours si pas de filtre
            if (!startDate && !endDate) {
                query = query.limit(30);
            }

            const { data, error } = await query;

            if (error) {
                console.error('Erreur chargement stats messages:', error);
                return;
            }

            const labels = data.map(d => new Date(d.day).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' }));
            const smsData = data.map(d => d.sms_count);
            const emailData = data.map(d => d.email_count);
            const failedData = data.map(d => d.failed_count);

            const ctx = document.getElementById('messagesChart').getContext('2d');
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            if (messagesChart) messagesChart.destroy();

            messagesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'SMS',
                            data: smsData,
                            backgroundColor: '#3B82F6',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Email',
                            data: emailData,
                            backgroundColor: '#10B981',
                            stack: 'Stack 0',
                        },
                        {
                            label: 'Échecs',
                            data: failedData,
                            backgroundColor: '#EF4444',
                            stack: 'Stack 1',
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: textColor } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { 
                            stacked: true,
                            beginAtZero: true, 
                            ticks: { color: textColor, stepSize: 1 }, 
                            grid: { color: gridColor } 
                        },
                        x: { 
                            stacked: true,
                            ticks: { color: textColor }, 
                            grid: { display: false } 
                        }
                    }
                }
            });
        }

        document.getElementById('msg-status-filter').addEventListener('change', () => {
            currentMsgPage = 1;
            loadMessagesHistoryTable();
        });
        document.getElementById('msg-channel-filter').addEventListener('change', () => {
            currentMsgPage = 1;
            loadMessagesHistoryTable();
        });

        async function loadMessagesHistoryTable() {
            const statusFilter = document.getElementById('msg-status-filter').value;
            const channelFilter = document.getElementById('msg-channel-filter').value;

            const from = (currentMsgPage - 1) * msgItemsPerPage;
            const to = from + msgItemsPerPage - 1;

            let query = supabaseClient
                .from('messages')
                .select('*, appointments(full_name, email, phone)', { count: 'exact' })
                .order('created_at', { ascending: false });

            if (statusFilter) query = query.eq('status', statusFilter);
            if (channelFilter) query = query.ilike('channel', `%${channelFilter}%`);

            const { data, error, count } = await query.range(from, to);

            if (error) {
                console.error('Erreur chargement historique messages:', error);
                return;
            }

            const tbody = document.getElementById('messages-table-body');
            tbody.innerHTML = '';

            data.forEach(msg => {
                const date = new Date(msg.created_at).toLocaleString('fr-FR');
                const clientName = msg.appointments?.full_name || 'Inconnu';
                const statusColor = msg.status === 'sent' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                const statusLabel = msg.status === 'sent' ? 'Envoyé' : 'Échec';
                const body = msg.body.length > 50 ? msg.body.substring(0, 50) + '...' : msg.body;
                
                let actionBtn = '';
                if (msg.status === 'failed') {
                    actionBtn = `<button onclick="openResendModal('${msg.id}')" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300 text-xs font-bold uppercase border border-blue-200 dark:border-blue-800 rounded px-2 py-1 hover:bg-blue-50 dark:hover:bg-blue-900 transition-colors">Réessayer</button>`;
                }

                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${clientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${msg.channel}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusColor}">${statusLabel}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400" title="${msg.body.replace(/"/g, '&quot;')}">${body}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${actionBtn}</td>
                    </tr>`;
                tbody.insertAdjacentHTML('beforeend', row);
            });

            updateMsgPaginationControls(count);
        }

        async function openResendModal(id) {
            try {
                const { data: msg, error } = await supabaseClient
                    .from('messages')
                    .select('*, appointments(full_name)')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                document.getElementById('resend-msg-id').value = msg.id;
                document.getElementById('resend-msg-body').value = msg.body;
                document.getElementById('resend-client-name').textContent = msg.appointments?.full_name || 'Inconnu';
                document.getElementById('resend-channel').textContent = msg.channel;

                document.getElementById('resend-modal').classList.remove('hidden');
            } catch (err) {
                console.error(err);
                showToast('Erreur chargement message: ' + err.message, true);
            }
        }

        function closeResendModal() {
            document.getElementById('resend-modal').classList.add('hidden');
        }
        
        document.getElementById('resend-overlay').addEventListener('click', closeResendModal);

        async function confirmResend() {
            const id = document.getElementById('resend-msg-id').value;
            const newBody = document.getElementById('resend-msg-body').value;
            const btn = document.getElementById('confirm-resend-btn');
            
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            try {
                const { data: msg, error } = await supabaseClient
                    .from('messages')
                    .select('*, appointments(full_name, email, phone)')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                const app = msg.appointments;
                const channel = msg.channel.toLowerCase();
                
                if (channel.includes('email')) {
                    if (!app.email) throw new Error("Email manquant");
                    const { error: mailError } = await supabaseClient.functions.invoke('Email-Service', {
                        body: {
                            userEmail: app.email,
                            subject: "Information concernant votre véhicule (Renvoi)",
                            message: newBody.replace(/\n/g, '<br>') + emailSignature
                        },
                        headers: { Authorization: `Bearer ${supabaseKey}` }
                    });
                    if (mailError) throw mailError;
                }

                if (channel.includes('sms')) {
                    if (!app.phone) throw new Error("Téléphone manquant");
                    const { error: smsError } = await supabaseClient.functions.invoke('SendSms', {
                        body: {
                            phoneNumber: app.phone,
                            phone: app.phone,
                            name: app.full_name,
                            message: newBody,
                            channels: ['sms']
                        },
                        headers: { Authorization: `Bearer ${supabaseKey}` }
                    });
                    if (smsError) throw smsError;
                }

                await supabaseClient.from('messages').update({ 
                    status: 'sent', 
                    body: newBody,
                    created_at: new Date().toISOString() 
                }).eq('id', id);
                
                showToast('Message renvoyé avec succès');
                closeResendModal();
                loadMessagesHistoryTable();

            } catch (err) {
                console.error(err);
                showToast('Erreur lors du renvoi: ' + err.message, true);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Envoyer';
            }
        }

        function updateMsgPaginationControls(totalCount) {
            const paginationDiv = document.getElementById('msg-pagination');
            if (totalCount === 0) {
                paginationDiv.classList.add('hidden');
                return;
            }
            paginationDiv.classList.remove('hidden');

            const totalPages = Math.ceil(totalCount / msgItemsPerPage);
            const start = (currentMsgPage - 1) * msgItemsPerPage + 1;
            const end = Math.min(currentMsgPage * msgItemsPerPage, totalCount);

            document.getElementById('msg-page-start').textContent = start;
            document.getElementById('msg-page-end').textContent = end;
            document.getElementById('msg-total-count').textContent = totalCount;

            const prevBtn = document.getElementById('msg-prev-page');
            const nextBtn = document.getElementById('msg-next-page');
            const prevBtnMobile = document.getElementById('msg-prev-page-mobile');
            const nextBtnMobile = document.getElementById('msg-next-page-mobile');

            const isFirstPage = currentMsgPage === 1;
            const isLastPage = currentMsgPage >= totalPages;

            [prevBtn, prevBtnMobile].forEach(btn => {
                btn.disabled = isFirstPage;
                btn.classList.toggle('opacity-50', isFirstPage);
                btn.classList.toggle('cursor-not-allowed', isFirstPage);
                btn.onclick = () => { if (!isFirstPage) { currentMsgPage--; loadMessagesHistoryTable(); } };
            });

            [nextBtn, nextBtnMobile].forEach(btn => {
                btn.disabled = isLastPage;
                btn.classList.toggle('opacity-50', isLastPage);
                btn.classList.toggle('cursor-not-allowed', isLastPage);
                btn.onclick = () => { if (!isLastPage) { currentMsgPage++; loadMessagesHistoryTable(); } };
            });
        }

        async function fetchSmsBalance() {
            const container = document.getElementById('sms-balance-container');
            const span = document.getElementById('sms-balance');
            const containerMobile = document.getElementById('sms-balance-container-mobile');
            const spanMobile = document.getElementById('sms-balance-mobile');

            try {
                const { data, error } = await supabaseClient.functions.invoke('getBalance', {
                    headers: {
                        Authorization: `Bearer ${supabaseKey}`
                    }
                });

                if (error) throw error;
                
                console.log('Solde SMS reçu:', data);

                if (data && (data.balance !== undefined || data.amount !== undefined || data.solde !== undefined)) {
                    const balance = data.balance || data.amount || data.solde;
                    const currency = data.currency || data.devise || '€';
                    
                    span.textContent = `${parseFloat(balance).toFixed(2)} ${currency}`;
                    container.classList.remove('hidden');

                    if (parseFloat(balance) < 5) {
                        container.classList.remove('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                        container.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                    } else {
                        container.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                        container.classList.remove('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                    }

                    if (containerMobile && spanMobile) {
                        spanMobile.textContent = `${parseFloat(balance).toFixed(2)} ${currency}`;
                        containerMobile.classList.remove('hidden');
                        if (parseFloat(balance) < 5) {
                            containerMobile.classList.remove('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                            containerMobile.classList.add('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                        } else {
                            containerMobile.classList.add('bg-blue-100', 'text-blue-800', 'dark:bg-blue-900', 'dark:text-blue-200');
                            containerMobile.classList.remove('bg-red-100', 'text-red-800', 'dark:bg-red-900', 'dark:text-red-200');
                        }
                    }
                }
            } catch (err) {
                console.error('Erreur récupération solde SMS:', err);
                if (container && span) {
                    container.classList.remove('hidden');
                    span.textContent = "Err";
                }
            }
        }

        document.getElementById('toast-close-btn').addEventListener('click', () => {
            const toast = document.getElementById('toast');
            if (toastTimeout) clearTimeout(toastTimeout);
            toast.classList.add('hidden');
        });

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            
            if (toastTimeout) clearTimeout(toastTimeout);

            if (typeof type === 'boolean') {
                type = type ? 'error' : 'success';
            }

            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            
            let iconHtml = '';
            if (type === 'error') {
                toast.classList.add('bg-red-500');
                iconHtml = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            } else {
                toast.classList.add('bg-green-500');
                iconHtml = '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            }
            
            if (toastIcon) toastIcon.innerHTML = iconHtml;
        }

        // Gestion de la connexion Internet
        window.addEventListener('online', () => showToast('Connexion Internet rétablie.', 'success'));
        window.addEventListener('offline', () => showToast('Pas de connexion Internet. Vérifiez votre réseau.', 'error'));

        // --- Gestion du Drag & Drop (Réorganisation) ---
        const grid = document.getElementById('stats-grid');
        let draggedItem = null;

        // Charger l'ordre sauvegardé
        const savedOrder = JSON.parse(localStorage.getItem('statsOrder'));
        if (savedOrder) {
            const items = Array.from(grid.children);
            // Trier les éléments selon l'ordre sauvegardé
            items.sort((a, b) => {
                const indexA = savedOrder.indexOf(a.id);
                const indexB = savedOrder.indexOf(b.id);
                // Si un nouvel élément n'est pas dans l'ordre sauvegardé, le mettre à la fin
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });
            // Réinsérer dans le DOM
            items.forEach(item => grid.appendChild(item));
        }

        // Ajouter les écouteurs d'événements
        const items = grid.querySelectorAll('.draggable-item');
        items.forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.classList.add('opacity-50');
                e.dataTransfer.effectAllowed = 'move';
                // Pour Firefox
                e.dataTransfer.setData('text/plain', '');
            });

            item.addEventListener('dragend', function(e) {
                this.classList.remove('opacity-50');
                this.classList.remove('border-2', 'border-blue-500', 'border-dashed');
                draggedItem = null;
                
                // Sauvegarder le nouvel ordre
                const newOrder = Array.from(grid.children).map(child => child.id);
                localStorage.setItem('statsOrder', JSON.stringify(newOrder));
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                this.classList.add('border-2', 'border-blue-500', 'border-dashed');
            });

            item.addEventListener('dragleave', function(e) {
                this.classList.remove('border-2', 'border-blue-500', 'border-dashed');
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('border-2', 'border-blue-500', 'border-dashed');
                
                if (this !== draggedItem) {
                    // Échanger les éléments dans le DOM
                    const allItems = Array.from(grid.children);
                    const draggedIndex = allItems.indexOf(draggedItem);
                    const droppedIndex = allItems.indexOf(this);

                    if (draggedIndex < droppedIndex) {
                        this.after(draggedItem);
                    } else {
                        this.before(draggedItem);
                    }
                }
            });
        });
    </script>
</body>
</html>