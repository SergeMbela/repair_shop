<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personnel - ATS Services</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <link rel="manifest" href="manifest.json">
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <!-- Theme Module -->
    <script src="js/theme.js"></script>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen font-sans">

    <nav class="bg-white dark:bg-gray-800 shadow mb-8">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <span class="font-bold text-xl text-blue-600 truncate">ATS Services <span
                    class="text-gray-600 dark:text-gray-300 text-sm hidden sm:inline">| Personnel</span></span>

            <!-- Desktop Menu -->
            <div class="hidden md:flex items-center space-x-4">
                <a href="admin.html" class="text-sm text-gray-500 hover:text-blue-600 font-medium">Planning</a>
                <a href="work_orders.html" class="text-sm text-gray-500 hover:text-blue-600 font-medium">Fiches de
                    travail</a>
                <a href="personnel.html"
                    class="text-sm text-blue-600 font-bold bg-blue-50 dark:bg-gray-700 rounded-md px-2 py-1">Personnel</a>
                <a href="stats.html" class="text-sm text-gray-500 hover:text-blue-600 font-medium">Statistiques</a>
                <a href="index.html" class="text-sm text-gray-500 hover:text-blue-600">Voir le site</a>
                <a href="settings.html" class="text-sm text-gray-500 hover:text-blue-600 font-medium">Paramètres</a>
                <button id="logout-btn" class="text-sm text-red-500 hover:text-red-700 font-medium">Déconnexion</button>
            </div>

            <!-- Mobile Menu Button -->
            <div class="md:hidden flex items-center">
                <button id="mobile-menu-btn" class="text-gray-500 hover:text-blue-600 focus:outline-none p-2">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu"
            class="hidden md:hidden border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
            <div class="px-4 py-3 space-y-1">
                <a href="admin.html"
                    class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Planning</a>
                <a href="work_orders.html"
                    class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Fiches
                    de travail</a>
                <a href="personnel.html"
                    class="block px-3 py-2 rounded-md text-base font-bold text-blue-600 bg-blue-50 dark:bg-gray-700 dark:text-white">Personnel</a>
                <a href="stats.html"
                    class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Statistiques</a>
                <a href="index.html"
                    class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Voir
                    le site</a>
                <a href="settings.html"
                    class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 dark:text-gray-200 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700">Paramètres</a>
                <button id="logout-btn-mobile"
                    class="w-full text-left block px-3 py-2 rounded-md text-base font-medium text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20">Déconnexion</button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 pb-12">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Gestion des Mécaniciens</h2>
            <div class="flex gap-3 w-full sm:w-auto">
                <div class="relative w-full sm:w-64">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <input type="text" id="search-mechanic" placeholder="Rechercher..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <button onclick="openModal()"
                    class="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition flex items-center whitespace-nowrap">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    Ajouter
                </button>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Nom</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Spécialité</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Contact</th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Statut</th>
                            <th
                                class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                Actions</th>
                        </tr>
                    </thead>
                    <tbody id="mechanics-table"
                        class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Les lignes seront insérées ici par JS -->
                    </tbody>
                </table>
            </div>
            <div id="loading" class="text-center py-8 text-gray-500">Chargement...</div>
        </div>
    </div>

    <!-- Modal Ajout/Modification -->
    <div id="mechanic-modal" class="fixed inset-0 z-50 hidden overflow-y-auto" aria-labelledby="modal-title"
        role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                id="modal-overlay"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div
                class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <form id="mechanic-form">
                    <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" id="modal-title">
                            Ajouter un mécanicien</h3>
                        <input type="hidden" id="mechanic-id">

                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Prénom</label>
                                <input type="text" id="first_name" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nom</label>
                                <input type="text" id="last_name" required
                                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email</label>
                            <input type="email" id="email"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Téléphone</label>
                            <input type="tel" id="phone"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Spécialité</label>
                            <input type="text" id="specialty" placeholder="Ex: Moteur, Pneus, Diagnostic..."
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Photo de profil
                                (URL)</label>
                            <input type="url" id="avatar_url" placeholder="https://exemple.com/photo.jpg"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        </div>

                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Couleur
                                    (Planning)</label>
                                <input type="color" id="color" value="#3B82F6"
                                    class="h-8 w-16 p-0 border-0 rounded cursor-pointer">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="is_active" checked
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded dark:bg-gray-700 dark:border-gray-600">
                                <label for="is_active"
                                    class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Actif</label>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                        <button type="submit"
                            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm">Enregistrer</button>
                        <button type="button" onclick="closeModal()"
                            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-500">Annuler</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"
        class="fixed top-5 left-1/2 -translate-x-1/2 max-w-sm w-full bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden z-50 transition-opacity duration-300">
        <div class="flex items-center">
            <span id="toast-message" class="flex-grow"></span>
        </div>
    </div>

    <script>
        if (!window.CONFIG || !window.CONFIG.SUPABASE_URL) throw new Error("Configuration manquante.");
        const supabaseUrl = window.CONFIG.SUPABASE_URL;
        const supabaseKey = window.CONFIG.SUPABASE_KEY;
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        let allMechanics = [];
        let searchQuery = '';

        // Auth Check
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (!session) window.location.href = 'admin.html';
            else fetchMechanics();
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'admin.html';
        });

        // Mobile Menu
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => mobileMenu.classList.toggle('hidden'));
        }
        const logoutBtnMobile = document.getElementById('logout-btn-mobile');
        if (logoutBtnMobile) {
            logoutBtnMobile.addEventListener('click', async () => {
                await supabaseClient.auth.signOut();
                window.location.href = 'admin.html';
            });
        }

        document.getElementById('search-mechanic').addEventListener('input', (e) => {
            searchQuery = e.target.value.toLowerCase();
            renderTable();
        });

        async function fetchMechanics() {
            const { data, error } = await supabaseClient
                .from('mechanics')
                .select('*')
                .order('first_name');

            document.getElementById('loading').classList.add('hidden');

            if (error) {
                console.error(error);
                showToast("Erreur lors du chargement.", true);
                return;
            }

            allMechanics = data;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('mechanics-table');
            tbody.innerHTML = '';

            const filteredMechanics = allMechanics.filter(mech => {
                const searchStr = (mech.first_name + ' ' + mech.last_name + ' ' + (mech.specialty || '') + ' ' + (mech.email || '') + ' ' + (mech.phone || '')).toLowerCase();
                return searchStr.includes(searchQuery);
            });

            filteredMechanics.forEach(mech => {
                const statusBadge = mech.is_active
                    ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">Actif</span>'
                    : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">Inactif</span>';

                let avatarHtml;
                if (mech.avatar_url) {
                    avatarHtml = `<img class="h-10 w-10 rounded-full object-cover mr-3 border-2" style="border-color: ${mech.color || '#3B82F6'};" src="${mech.avatar_url}" alt="${mech.first_name}">`;
                } else {
                    const initials = (mech.first_name[0] + mech.last_name[0]).toUpperCase();
                    avatarHtml = `<div class="h-10 w-10 rounded-full mr-3 flex items-center justify-center text-white font-bold text-sm" style="background-color: ${mech.color || '#3B82F6'};">${initials}</div>`;
                }

                const row = `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white flex items-center">
                            ${avatarHtml} ${mech.first_name} ${mech.last_name}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${mech.specialty || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            <div>${mech.email || ''}</div>
                            <div>${mech.phone || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="openModal('${mech.id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3">Modifier</button>
                            <button onclick="deleteMechanic('${mech.id}')" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Supprimer</button>
                        </td>
                    </tr>
                `;
                tbody.insertAdjacentHTML('beforeend', row);
            });
        }

        const modal = document.getElementById('mechanic-modal');
        const form = document.getElementById('mechanic-form');

        window.openModal = (id = null) => {
            document.getElementById('mechanic-id').value = id || '';
            document.getElementById('modal-title').textContent = id ? 'Modifier le mécanicien' : 'Ajouter un mécanicien';

            if (id) {
                const mech = allMechanics.find(m => m.id === id);
                document.getElementById('first_name').value = mech.first_name;
                document.getElementById('last_name').value = mech.last_name;
                document.getElementById('email').value = mech.email || '';
                document.getElementById('phone').value = mech.phone || '';
                document.getElementById('specialty').value = mech.specialty || '';
                document.getElementById('avatar_url').value = mech.avatar_url || '';
                document.getElementById('color').value = mech.color || '#3B82F6';
                document.getElementById('is_active').checked = mech.is_active;
            } else {
                form.reset();
                document.getElementById('color').value = '#3B82F6';
                document.getElementById('avatar_url').value = '';
                document.getElementById('is_active').checked = true;
            }
            modal.classList.remove('hidden');
        };

        window.closeModal = () => modal.classList.add('hidden');
        document.getElementById('modal-overlay').onclick = closeModal;

        form.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('mechanic-id').value;

            const mechanicData = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value || null,
                phone: document.getElementById('phone').value || null,
                specialty: document.getElementById('specialty').value || null,
                avatar_url: document.getElementById('avatar_url').value || null,
                color: document.getElementById('color').value,
                is_active: document.getElementById('is_active').checked
            };

            let error;
            if (id) {
                const { error: err } = await supabaseClient.from('mechanics').update(mechanicData).eq('id', id);
                error = err;
            } else {
                const { error: err } = await supabaseClient.from('mechanics').insert([mechanicData]);
                error = err;
            }

            if (error) {
                showToast("Erreur : " + error.message, true);
            } else {
                showToast(id ? "Mécanicien mis à jour." : "Mécanicien ajouté.");
                closeModal();
                fetchMechanics();
            }
        };

        window.deleteMechanic = async (id) => {
            if (confirm("Êtes-vous sûr de vouloir supprimer ce mécanicien ?")) {
                const { error } = await supabaseClient.from('mechanics').delete().eq('id', id);
                if (error) showToast("Erreur suppression : " + error.message, true);
                else {
                    showToast("Mécanicien supprimé.");
                    fetchMechanics();
                }
            }
        };

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            msg.textContent = message;
            toast.classList.remove('hidden', 'bg-green-500', 'bg-red-500');
            toast.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>

</html>